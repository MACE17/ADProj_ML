name: Deploy ML API to AWS with SAST & DAST

on:
  push:
    branches:
      - main  # 只有 push 到 main 分支时触发

jobs:
  # ========== 1️⃣ SAST（静态代码安全测试） ==========
  sast:
    runs-on: ubuntu-latest
    steps:
      - name: 🚀 Checkout Repository
        uses: actions/checkout@v4

      - name: 🛡️ Run CodeQL Analysis (SAST)
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: 🔍 Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: 🛡️ Run Bandit (Python Security Scanner)
        run: |
          pip install bandit
          bandit -r .  # 扫描整个项目

  # ========== 2️⃣ 部署到 AWS EC2 ==========
  deploy:
    runs-on: ubuntu-latest
    needs: sast  # 先运行 SAST 扫描，确保代码安全
    steps:
      - name: 🚀 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔧 Set up Docker (Fix containerd conflict)
        run: |
          sudo apt-get update
          sudo apt-get remove -y containerd.io containerd || true
          sudo apt-get autoremove -y
          sudo apt-get install -y docker.io

      - name: 🏗️ Build Docker Image
        run: |
          docker build -t my_ml_app .

      - name: 🖥️ SSH into EC2 and Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ubuntu
          key: ${{ secrets.AWS_PRIVATE_KEY }}
          script: |
            cd ~/project_root
            git pull origin main  # 获取最新代码
            docker stop my_ml_app || true
            docker rm my_ml_app || true
            docker build -t my_ml_app .
            docker run -d -p 5000:5000 --name my_ml_app my_ml_app

  # ========== 3️⃣ DAST（动态 API 安全测试） ==========
  dast:
    runs-on: ubuntu-latest
    needs: deploy  # 只有 API 部署完成后才运行 DAST
    steps:
      - name: 🔍 Run OWASP ZAP API Scan
        uses: zaproxy/action-api-scan@v0.5.0
        with:
          target: "http://${{ secrets.AWS_HOST }}:5000"  # 你的 API 地址
          fail_action: false  # 避免因小问题失败
