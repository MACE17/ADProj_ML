name: Deploy ML API to AWS with SAST & DAST

on:
  push:
    branches:
      - main  # åªæœ‰ push åˆ° main åˆ†æ”¯æ—¶è§¦å‘

jobs:
  # ========== 1ï¸âƒ£ SASTï¼ˆé™æ€ä»£ç å®‰å…¨æµ‹è¯•ï¼‰ ==========
  sast:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Run CodeQL Analysis (SAST)
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: ğŸ›¡ï¸ Run Bandit (Python Security Scanner)
        run: |
          pip install bandit
          bandit -r .  # æ‰«ææ•´ä¸ªé¡¹ç›®

  # ========== 2ï¸âƒ£ éƒ¨ç½²åˆ° AWS EC2 ==========
  deploy:
    runs-on: ubuntu-latest
    needs: sast  # å…ˆè¿è¡Œ SAST æ‰«æï¼Œç¡®ä¿ä»£ç å®‰å…¨
    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker (Fix containerd conflict)
        run: |
          sudo apt-get update
          sudo apt-get remove -y containerd.io containerd || true
          sudo apt-get autoremove -y
          sudo apt-get install -y docker.io

      - name: ğŸ—ï¸ Build Docker Image
        run: |
          docker build -t my_ml_app .

      - name: ğŸ–¥ï¸ SSH into EC2 and Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ubuntu
          key: ${{ secrets.AWS_PRIVATE_KEY }}
          script: |
            cd ~/project_root
            git pull origin main  # è·å–æœ€æ–°ä»£ç 
            docker stop my_ml_app || true
            docker rm my_ml_app || true
            docker build -t my_ml_app .
            docker run -d -p 5000:5000 --name my_ml_app my_ml_app

  # ========== 3ï¸âƒ£ DASTï¼ˆåŠ¨æ€ API å®‰å…¨æµ‹è¯•ï¼‰ ==========
  dast:
    runs-on: ubuntu-latest
    needs: deploy  # åªæœ‰ API éƒ¨ç½²å®Œæˆåæ‰è¿è¡Œ DAST
    steps:
      - name: ğŸ” Run OWASP ZAP API Scan
        uses: zaproxy/action-api-scan@v0.5.0
        with:
          target: "http://${{ secrets.AWS_HOST }}:5000"  # ä½ çš„ API åœ°å€
          fail_action: false  # é¿å…å› å°é—®é¢˜å¤±è´¥
